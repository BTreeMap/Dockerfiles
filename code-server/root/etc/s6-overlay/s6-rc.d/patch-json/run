#!/usr/bin/with-contenv bash

# Set default options for patching behavior if not defined externally
: "${PATCH_JSON_USE_FORCE:=true}"           # Enables '--force' flag by default
: "${PATCH_JSON_ENABLE_SORT_KEYS:=true}"    # Enables JSON key sorting by default

# Helper function to determine if a value is "truthy"
is_truthy() {
    local val
    # Return false if variable is not set or empty
    if [ -z "$1" ]; then
        return 1
    fi
    
    # Convert to lowercase
    val=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    
    # Check for truthy values
    case "$val" in
        true|yes|1|on|y)
            return 0 # True
            ;;
        *)
            return 1 # False
            ;;
    esac
}

# Function: patch_and_echo
# Description: Applies patches to a JSON file with optional flags, and logs the operation details.
patch_and_echo() {
  local source_file="$1"
  shift
  local patch_files=("$@")
  
  # Build flags based on environment variables
  local flags=""
  if is_truthy "$PATCH_JSON_USE_FORCE"; then
    flags+=" --force"
  fi
  if ! is_truthy "$PATCH_JSON_ENABLE_SORT_KEYS"; then
    flags+=" --no-sort-keys"
  fi

  echo "Applying patch to '$source_file' using: ${patch_files[*]}. Flags: '$flags'."
  /opt/shared-venv/bin/python /opt/code-server-scripts/patch_json.py --source "$source_file" $flags --in-place "${patch_files[@]}"
}

# Check if PATCH_JSON is set to a value representing "true"
if is_truthy PATCH_JSON; then
  patch_and_echo /config/data/Machine/settings.json /usr/share/code-server-scripts/patch_json/settings/*.json
  patch_and_echo /config/data/User/settings.json /usr/share/code-server-scripts/patch_json/settings/*.json
  echo "All JSON patches applied successfully."
else
  echo "PATCH_JSON is not enabled. Skipping JSON patching."
fi
